/*
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    LMDseq Nextflow config file
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    Default config options for laser microdissection RNA-seq analysis
    
    Pipeline Features:
    - Kallisto pseudo-alignment optimized for low-input LMD samples
    - Flexible output formats: minimal (gene_id + counts) or enriched (full annotations)
    - Custom genome/transcript FASTA support
    - DESeq2 normalization and comprehensive QC analysis
    - No UMI processing or rRNA depletion (not needed for LMD samples)
    - Flexible output: minimal (gene_id + counts) or enriched (full annotations)
----------------------------------------------------------------------------------------
*/


// Global default params, used in configs
params {
    // Input options
    input                      = null              // Path to sample metadata file (Sample.txt)

    // Reference genome options (flexible - choose what fits your needs)
    genome                     = null              // iGenomes genome ID (e.g., GRCh38, GRCm39)
    fasta                      = null              // Custom genome FASTA file
    gtf                        = null              // Gene annotation GTF file  
    transcript_fasta           = null              // Custom transcript FASTA file (skips genome processing)
    reference                  = null              // Recommended: gene annotation reference file (enables rich output with symbols, names, coordinates)
    gencode                    = false             // Set true if using GENCODE GTF format
    skip_gtf_filter            = true              // Skip GTF filtering (recommended for LMD)
    save_reference             = false             // Save generated reference files
    igenomes_base              = 's3://ngi-igenomes/igenomes/'
    igenomes_ignore            = false

    // BBSplit genome filtering
    bbsplit_fasta_list         = null
    skip_bbsplit               = true

    // UMI options (not used for LMD samples)
    with_umi                   = false
    skip_umi_extract           = true
    umitools_bc_pattern        = null
    umitools_bc_pattern2       = null
    umitools_grouping_method   = 'directional'
    umi_dedup_tool             = 'dedup'

    // Ribosomal RNA removal (not used for LMD samples)
    remove_ribo_rna            = false
    ribo_database_manifest     = "${projectDir}/workflows/assets/rrna-db-defaults.txt"

    // Options: Trimming
    trimmer                    = 'trimgalore'
    extra_trimgalore_args      = '--clip_R2 3 --quality 20 --stringency 3 --length 20'
    skip_fastqc                = false      
    skip_trimming              = false      
    
    // Options: Pseudo-alignment (Primary method for LMDseq)
    pseudo_aligner             = 'kallisto'       // Kallisto pseudo-alignment for LMD samples
    skip_pseudo_alignment      = false
    extra_kallisto_quant_args  = '-b 50 --single-overhang'
    extra_kallisto_index_args  = null
    kallisto_quant_fraglen     = 200
    kallisto_quant_fraglen_sd  = 200
    kallisto_kmer_size         = 31
    
    // Traditional alignment (not used - pseudo-alignment only)
    skip_alignment             = true             // LMDseq uses only pseudo-alignment
    
    // Other options
    bin_size                   = 1
    index                      = null
    gtf                        = null
    chromosomes                = null
    reference                  = null             // Optional: gene annotation reference file (skip annotation if not provided)
    
    // Sequencing mode
    seq_mode                   = 'SE'  // Single-end by default for LMD samples
    
    // MultiQC skip option
    skip_multiqc               = false

    // Options: DESeq2 QC
    min_reads                  = 10



    // Salmon pseudo-alignment options (for compatibility)
    salmon_index               = null

    // Additional sequences
    additional_fasta           = null

    // Contaminant screening options
    contaminant_screening      = false
    kraken_db                  = null
    save_kraken_assignments    = false
    save_kraken_unassigned     = false
    bracken_precision          = 'S'

    // RSeQC options
    rseqc_modules              = null

    // MultiQC options
    multiqc_config             = null
    multiqc_title              = null
    multiqc_logo               = null
    max_multiqc_email_size     = '25.MB'
    multiqc_methods_description = null

    // Boilerplate options
    outdir                       = null
    publish_dir_mode             = 'copy'
    publish_dir_overwrite        = false
    email                        = null
    email_on_fail                = null
    plaintext_email              = false
    monochrome_logs              = false
    hook_url                     = null
    version                      = false
    trace_report_suffix          = new java.util.Date().format( 'yyyy-MM-dd_HH-mm-ss')// Config options
    pipelines_testdata_base_path = 'https://raw.githubusercontent.com/nf-core/test-datasets/7f1614baeb0ddf66e60be78c3d9fa55440465ac8/'

    // Schema validation default options
    validate_params            = false  // keep always FALSE !

    // Max resource options
    // Defaults only, expecting to be overwritten
    max_memory                 = '16.GB'
    max_cpus                   = 10
    max_time                   = '240.h'
}

// Default publishing logic for pipeline
process {
    publishDir = [
        path: { "${params.outdir}/${task.process.tokenize(':')[-1].tokenize('_')[0].toLowerCase()}" },
        mode: params.publish_dir_mode,
        saveAs: { filename -> filename.equals('versions.yml') ? null : filename }
    ]
}

// Load base.config by default for all pipelines
includeConfig 'conf/base.config'
// Load modules.config for DSL2 module specific options
includeConfig 'conf/modules.config'
// Load igenomes.config if required
includeConfig !params.igenomes_ignore ? 'conf/igenomes.config' : 'conf/igenomes_ignored.config'

// Load DSL2 module specific options
includeConfig "./subworkflows/local/prepare_genome/nextflow.config"
//includeConfig './workflows/nextflow.config'

profiles {
    debug { process.beforeScript = 'echo $HOSTNAME' }
    conda {
        enable_conda           = true
        conda.channels         = ['bioconda', 'conda-forge']
        docker.enabled         = false
        singularity.enabled    = false
        podman.enabled         = false
        shifter.enabled        = false
        charliecloud.enabled   = false
    }
    mamba {
        enable_conda           = true
        conda.useMamba         = true
        docker.enabled         = false
        singularity.enabled    = false
        podman.enabled         = false
        shifter.enabled        = false
        charliecloud.enabled   = false
    }
    singularity {
        singularity.enabled    = true
        singularity.autoMounts = true
        docker.enabled         = false
        podman.enabled         = false
        shifter.enabled        = false
        charliecloud.enabled   = false
    }
    docker {
        docker.enabled         = false
        docker.userEmulation   = false
        singularity.enabled    = false
        podman.enabled         = false
        shifter.enabled        = false
        charliecloud.enabled   = false
    }
    test      { includeConfig 'conf/test.config'      }
    test_full { includeConfig 'conf/test_full.config' }
    test_lmd  { includeConfig 'conf/test_lmd.config'  }
}

// Load igenomes.config if required
if (!params.igenomes_ignore) {
    includeConfig 'conf/igenomes.config'
} else {
    params.genomes = [:]
}

// Capture exit codes from upstream processes when piping
process.shell = ['/bin/bash', '-euo', 'pipefail']

// Enable trace logging for all processes
timeline {
    enabled = true
    overwrite = true
    file = 'timeline.html'
}
report {
    enabled = true
    overwrite = true
    file = 'report.html'
}
trace {
    enabled = true
    overwrite = true
    file = 'trace.txt'
}
dag {
    enabled = true
    overwrite = true
    file = 'pipeline_dag.html'
}


// Manifest
manifest {
    name            = 'LMD_RNAseq'
    description     = 'RNA-seq from low input samples.'
    author          = 'Pierluigi Di Chiaro'
    contributors    = [
        [
            name: 'Pierluigi Di Chiaro',
            affiliation: 'AUSL-IRCCS Reggio Emilia',
            email: '',
            github: '@drpatelh',
            contribution: ['author'], // List of contribution types ('author', 'maintainer' or 'contributor')
            orcid: ''
        ]
    ]
    homePage        = ''
    mainScript      = 'main.nf'
    nextflowVersion = '!>=21.10.3'
    version         = '0.0.1'
}


// Nextflow plugins
enablePlugins = true

plugins {
    id 'nf-schema@2.3.0' // Validation of pipeline parameters and creation of an input channel from a sample sheet
}
